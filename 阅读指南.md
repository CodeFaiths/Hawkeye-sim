# Hawkeye 代码阅读指南

## 项目概述
Hawkeye 是一个用于诊断 RDMA 网络性能异常的系统，包含：
- NS-3 网络模拟器（`simulation/`）
- 检测代理（`detection-agent/`）
- Tofino 交换机代码（`switch/` 和 `ctrl/`）

## 推荐阅读路径

### 第一步：理解项目背景（15分钟）
1. 阅读 `README.md` 了解项目目标
2. 查看配置文件：
   - `simulation/mix/config.txt` - 模拟参数配置
   - `simulation/mix/topology.txt` - 网络拓扑
   - `simulation/mix/flow.txt` - 流量定义

### 第二步：理解主程序流程（30-60分钟）
**入口文件：`simulation/scratch/third.cc`**

阅读顺序：
1. **main() 函数**（第365行开始）
   - 配置读取（365-722行）
   - 拓扑构建（758-850行）
   - 路由计算（850-950行）
   - 流量调度（950-1050行）
   - 模拟运行（1050-1112行）

2. **关键全局变量**（1-134行）
   - 理解各种配置参数的含义
   - 注意 `agent_nodes`、`no_cc_nodes` 等特殊节点集合

3. **路由计算函数**
   - `CalculateRouteAll()` - 手动路由配置
   - `CalculateRoutes()` - 自动路由计算

### 第三步：理解核心模块（按需深入）

#### 1. RDMA 硬件层
- **`src/point-to-point/model/rdma-hw.h/cc`**
  - RDMA 硬件实现
  - 拥塞控制逻辑
  - NPA（Network Path Agent）相关功能

- **`src/point-to-point/model/rdma-queue-pair.h/cc`**
  - 队列对（QP）管理
  - 发送/接收逻辑

#### 2. 交换机节点
- **`src/point-to-point/model/switch-node.h/cc`**
  - 数据包转发逻辑
  - PFC（Priority Flow Control）处理
  - 遥测数据收集（`FlowTelemetryData`、`PortTelemetryData`）
  - 关键函数：
    - `SwitchReceiveFromDevice()` - 接收数据包
    - `CheckAndSendPfc()` - PFC 触发
    - `OutputTelemetry()` - 输出遥测数据

#### 3. 网络设备
- **`src/point-to-point/model/qbb-net-device.h/cc`**
  - QBB 网络设备实现
  - PFC 帧处理

#### 4. 应用层
- **`src/applications/model/rdma-client.h/cc`**
  - RDMA 客户端应用
  - 流量生成

### 第四步：理解特定场景

#### 死锁场景分析
- **`simulation/scratch/third_deadlock.cc`**
  - 重点关注 `CalculateRouteAll()`（229-322行）
  - 理解如何通过路由配置构造死锁场景

#### 遥测数据收集
- 查看 `switch-node.cc` 中的遥测相关代码
- 理解 `FlowTelemetryData` 和 `PortTelemetryData` 结构
- 查看数据输出逻辑

## 关键概念

### 1. RDMA（Remote Direct Memory Access）
- 远程直接内存访问，用于高性能网络通信

### 2. PFC（Priority Flow Control）
- 优先级流控制，用于无损网络

### 3. NPA（Network Path Agent）
- 网络路径代理，用于性能异常检测

### 4. 拥塞控制模式
- `cc_mode` 参数控制不同的拥塞控制算法

### 5. 遥测数据
- 交换机收集的流级别和端口级别的性能数据

## 调试技巧

1. **使用日志**
   - 代码中使用了 `NS_LOG_*` 宏，可以通过日志级别控制输出

2. **查看输出文件**
   - FCT 输出：`mix/fct.txt`
   - PFC 输出：`mix/pfc.txt`
   - 遥测数据：`mix/data/` 目录

3. **理解配置参数**
   - 修改 `config.txt` 来改变模拟行为
   - 注意 `AGENT_NODE` 和 `NO_CC_NODE` 的作用

## 常见问题

1. **路由是如何计算的？**
   - 查看 `CalculateRoutes()` 函数
   - 理解 `nextHop` 数据结构

2. **PFC 是如何触发的？**
   - 查看 `switch-node.cc` 中的 `CheckAndSendPfc()`
   - 理解队列深度阈值

3. **遥测数据如何收集？**
   - 查看 `switch-node.cc` 中的遥测数据结构
   - 理解 `OutputTelemetry()` 函数

## 下一步

根据你的具体需求，可以：
- 修改路由策略（`CalculateRouteAll()`）
- 调整拥塞控制参数
- 分析遥测数据输出
- 理解死锁检测机制

